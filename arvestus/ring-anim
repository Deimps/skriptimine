#!/bin/bash
# Nimi   : Deimo Sarapson
# Fail   : ring-anim
# Kirjeldus: ASCII ring â€“ rotating red sweep + green pulse (Xmas theme).

set -euo pipefail

STUDENT_NAME="${STUDENT_NAME:-Deimo Sarapson}"
TITLE="${TITLE:-Kontrolltoo - Rongaanimatsioon}"

# Base ring parameters
R=${R:-12}            # base radius (rows)
THICK=${THICK:-1.2}   # half thickness (float)
AMP=${AMP:-2.0}       # pulse amplitude (float)

# Animation speeds
FPS=${FPS:-24}              # frames per second
ROT_SPEED=${ROT_SPEED:-0.22}      # radians per frame (sweep rotation)
PULSE_SPEED=${PULSE_SPEED:-0.10}  # radians per frame (radius pulsing)

# Sweep width and aspect ratio
SWEEP_WIDTH=${SWEEP_WIDTH:-1.3}   # radians of bright arc
SCALEX=${SCALEX:-2.0}             # horizontal stretch for terminal aspect

# Colors (true ESC, not literal \e)
CLR_RING=$'\033[2;32m'   # faint green
CLR_SWEEP=$'\033[1;31m'  # bright red
CLR_RST=$'\033[0m'

# Disable colors if stdout is not a TTY
[[ -t 1 ]] || { CLR_RING=""; CLR_SWEEP=""; CLR_RST=""; }

# Hide cursor and clear screen; restore on exit
printf $'\033[?25l\033[2J'
trap 'printf $"\033[?25h\033[0m\n"' EXIT INT TERM

# Frame pacing
SLEEP=$(awk -v f="$FPS" 'BEGIN{printf("%.4f", 1.0/f)}')

phase=0    # sweep angle phase [0..2pi)
pulse=0    # pulsing phase [0..2pi)

while :; do
  # Header
  printf $'\033[H'  # cursor home
  now=$(date '+%F %T')
  printf '\033[1m%s\033[0m\n' "$TITLE"
  printf 'Nimi: %s  |  Aeg: %s\n\n' "$STUDENT_NAME" "$now"

  # Render one frame in awk (fast trig)
  awk -v R="$R" -v TH="$THICK" -v AMP="$AMP" \
      -v phase="$phase" -v pulse="$pulse" -v width="$SWEEP_WIDTH" -v rx="$SCALEX" \
      -v c1="$CLR_RING" -v c2="$CLR_SWEEP" -v cr="$CLR_RST" '
    function abs(x){return x<0?-x:x}
    BEGIN{
      pi = atan2(0,-1)

      # Pulse radius and thickness with sine
      Rt  = R  + AMP * sin(pulse)
      THt = TH + 0.30*AMP * sin(pulse)
      if (THt < 0.5) THt = 0.5

      Rin  = Rt - THt
      Rout = Rt + THt
      Rin2 = Rin*Rin
      Rout2= Rout*Rout

      Rmax = int(R + AMP + TH + 2)
      xmin = -int(rx*Rmax)
      xmax =  int(rx*Rmax)
      ymin = -Rmax
      ymax =  Rmax

      for (y=ymax; y>=ymin; y--) {
        line=""
        for (x=xmin; x<=xmax; x++) {
          xf = x / rx
          yf = y * 1.0
          d2 = xf*xf + yf*yf

          if (d2 >= Rin2 && d2 <= Rout2) {
            ang = atan2(yf, xf)            # -pi..pi
            if (ang < 0) ang += 2*pi       # 0..2pi

            d = ang - phase                # shortest angular distance
            if (d >  pi) d -= 2*pi
            else if (d < -pi) d += 2*pi

            if (abs(d) <= width/2) {
              line = line c2 "*" cr        # red sweep
            } else {
              line = line c1 "*" cr        # green ring
            }
          } else {
            line = line " "
          }
        }
        print line
      }
    }'

  # Advance phases and wrap to [0..2pi)
  phase=$(awk -v p="$phase" -v s="$ROT_SPEED" 'BEGIN{pi=atan2(0,-1); p+=s; if(p>=2*pi)p-=2*pi; printf("%.6f",p)}')
  pulse=$(awk -v p="$pulse" -v s="$PULSE_SPEED" 'BEGIN{pi=atan2(0,-1); p+=s; if(p>=2*pi)p-=2*pi; printf("%.6f",p)}')

  sleep "$SLEEP"
done
