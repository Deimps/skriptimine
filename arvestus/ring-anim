#!/bin/bash
# Nimi   : Deimo Sarapson
# Fail   : ring-anim
# Kirjeldus: ASCII rõngas – pöörlev punane kaar + roheline pulse (jõuluteema).

set -euo pipefail

STUDENT_NAME="${STUDENT_NAME:-Deimo Sarapson}"
TITLE="${TITLE:-Kontrolltöö – Rõngaanimatsioon}"

# Rõnga põhiparameetrid
R=${R:-12}            # baasraadius (ridadena)
THICK=${THICK:-1.2}   # poolpaksus (ujukomaarv)
AMP=${AMP:-2.0}       # pulsi amplituud (ujukomaarv)

# Animatsiooni kiirused
FPS=${FPS:-24}               # kaadrit sekundis
ROT_SPEED=${ROT_SPEED:-0.22} # radiaani kaadri kohta (pöörleva kaare kiirus)
PULSE_SPEED=${PULSE_SPEED:-0.10}  # radiaani kaadri kohta (raadiuse pulseerimine)

# Pöörleva kaare laius ja kuvasuhe
SWEEP_WIDTH=${SWEEP_WIDTH:-1.3}  # eredalt värvitud kaare laius radiaanides
SCALEX=${SCALEX:-2.0}            # horisontaalne venitus (terminali kuvasuhte kompenseerimiseks)

# Värvid (päris ESC-koodid, mitte sõnasõnaline \e)
CLR_RING=$'\033[2;32m'   # hele roheline (rõngas)
CLR_SWEEP=$'\033[1;31m'  # ere punane (pöörlev kaar)
CLR_RST=$'\033[0m'

# Kui väljund ei ole terminal (TTY), lülita värvid välja
[[ -t 1 ]] || { CLR_RING=""; CLR_SWEEP=""; CLR_RST=""; }

# Peida kursor ja puhasta ekraan; taasta väljumisel
printf $'\033[?25l\033[2J'
trap 'printf $"\033[?25h\033[0m\n"' EXIT INT TERM

# Kaadrite ajastus
SLEEP=$(awk -v f="$FPS" 'BEGIN{printf("%.4f", 1.0/f)}')

phase=0    # pöörleva kaare faas [0..2π)
pulse=0    # pulsi faas [0..2π)

while :; do
  # Päis
  printf $'\033[H'  # kursori asukoht (home)
  now=$(date '+%F %T')
  printf '\033[1m%s\033[0m\n' "$TITLE"
  printf 'Nimi: %s  |  Aeg: %s\n\n' "$STUDENT_NAME" "$now"

  # Joonista üks kaader awk abil (kiire trig.)
  awk -v R="$R" -v TH="$THICK" -v AMP="$AMP" \
      -v phase="$phase" -v pulse="$pulse" -v width="$SWEEP_WIDTH" -v rx="$SCALEX" \
      -v c1="$CLR_RING" -v c2="$CLR_SWEEP" -v cr="$CLR_RST" '
    function abs(x){return x<0?-x:x}
    BEGIN{
      pi = atan2(0,-1)

      # Pulseerimine: sile sinusoidaalne muutus
      Rt  = R  + AMP * sin(pulse)        # hetkeraadius
      THt = TH + 0.30*AMP * sin(pulse)   # hetke paksus (väiksema amplituudiga)
      if (THt < 0.5) THt = 0.5

      Rin  = Rt - THt                    # siseraadius
      Rout = Rt + THt                    # välisraadius
      Rin2 = Rin*Rin
      Rout2= Rout*Rout

      Rmax = int(R + AMP + TH + 2)
      xmin = -int(rx*Rmax)
      xmax =  int(rx*Rmax)
      ymin = -Rmax
      ymax =  Rmax

      for (y=ymax; y>=ymin; y--) {
        line=""
        for (x=xmin; x<=xmax; x++) {
          xf = x / rx
          yf = y * 1.0
          d2 = xf*xf + yf*yf

          if (d2 >= Rin2 && d2 <= Rout2) {
            ang = atan2(yf, xf)            # nurk vahemikus -π..π
            if (ang < 0) ang += 2*pi       # teisenda 0..2π

            # lühim nurgavahe pöörleva kaare keskmega
            d = ang - phase
            if (d >  pi) d -= 2*pi
            else if (d < -pi) d += 2*pi

            if (abs(d) <= width/2) {
              line = line c2 "*" cr        # punane pöörlev kaar
            } else {
              line = line c1 "*" cr        # roheline rõngas
            }
          } else {
            line = line " "
          }
        }
        print line
      }
    }'

  # Nihuta faase edasi ja mähkima 0..2π vahemikku
  phase=$(awk -v p="$phase" -v s="$ROT_SPEED" 'BEGIN{pi=atan2(0,-1); p+=s; if(p>=2*pi)p-=2*pi; printf("%.6f",p)}')
  pulse=$(awk -v p="$pulse" -v s="$PULSE_SPEED" 'BEGIN{pi=atan2(0,-1); p+=s; if(p>=2*pi)p-=2*pi; printf("%.6f",p)}')

  sleep "$SLEEP"
done
